# 파일 구조 복사 스크립트

업로드된 파일들의 폴더 구조를 그대로 복사하는 Node.js 스크립트입니다.

## 기능

- 📁 **논리적 폴더 구조 완전 복사**: 사용자가 만든 모든 폴더 계층 구조 복사
- 📄 **원본 파일 복사**: 물리적 파일을 새 위치로 복사 (썸네일 제외)
- 🗄️ **데이터베이스 레코드 생성**: 복사된 파일에 대한 DB 레코드 자동 생성
- 📊 **실시간 진행률 표시**: 폴더/파일 복사 진행 상황 표시
- ⚡ **배치 처리**: 대용량 파일도 안정적으로 처리
- 🔄 **에러 복구**: 실패한 파일은 건너뛰고 계속 진행

## 사전 요구사항

1. **Node.js** 18+ 설치
2. **서버 직접 접근** 권한
3. **환경 변수** 설정:
   ```bash
   SUPABASE_URL=your-supabase-url
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   ```

## 설치

```bash
# 프로젝트 루트에서
npm install @supabase/supabase-js dotenv
```

## 사용법

### 1. 동일 사용자 내 복사 (백업)
```bash
node scripts/copy-structure.js --source-user=550e8400-e29b-41d4-a716-446655440000 --target-path=/backup/user-files
```

### 2. 다른 사용자에게 복사
```bash
node scripts/copy-structure.js \
  --source-user=550e8400-e29b-41d4-a716-446655440000 \
  --target-user=123e4567-e89b-12d3-a456-426614174000 \
  --target-path=/backup/user-files
```

### 3. 외부 저장소로 백업
```bash
node scripts/copy-structure.js \
  --source-user=550e8400-e29b-41d4-a716-446655440000 \
  --target-path=/mnt/external-drive/backup
```

## 파라미터

| 파라미터 | 필수 | 설명 | 예시 |
|---------|------|------|------|
| `--source-user` | ✅ | 복사할 소스 사용자 ID | `550e8400-e29b-41d4-a716-446655440000` |
| `--target-user` | ❌ | 복사 대상 사용자 ID (없으면 동일 사용자) | `123e4567-e89b-12d3-a456-426614174000` |
| `--target-path` | ✅ | 복사될 물리적 파일 저장 경로 | `/backup/files` |

## 복사 과정

1. **📋 데이터 조회**: 소스 사용자의 폴더 구조와 파일 목록 조회
2. **📁 폴더 생성**: 폴더 계층 구조를 depth 순서대로 복사
3. **📄 파일 복사**: 물리적 파일 복사 + DB 레코드 생성
4. **📊 결과 보고**: 성공/실패 건수 및 세부 내역 출력

## 출력 예시

```
🚀 파일 구조 복사를 시작합니다...
📂 소스 사용자: 550e8400-e29b-41d4-a716-446655440000
📂 타겟 사용자: 550e8400-e29b-41d4-a716-446655440000
📂 타겟 경로: /backup/user-files

📋 소스 데이터 조회 중...
📁 폴더 15개 발견
📄 파일 5247개 발견

📁 15개 폴더 구조 복사 중...
폴더 생성 진행률: 100% (15/15)
✅ 폴더 구조 복사 완료

📄 5247개 파일 복사 중...
파일 복사 진행률: 100% (5247/5247) | 성공: 5244, 실패: 3
✅ 파일 복사 완료: 성공 5244개, 실패 3개

📊 복사 결과 요약:
  📁 폴더: 15개 복사
  📄 파일: 5244개 성공, 3개 실패

🎉 구조 복사가 완료되었습니다!
```

## 성능 예상

| 파일 수 | 평균 크기 | 로컬 SSD | 로컬 HDD | 네트워크 |
|---------|-----------|----------|----------|----------|
| 1,000개 | 5MB | 30초-1분 | 3-5분 | 5-20분 |
| 5,000개 | 5MB | 2-4분 | 15-30분 | 30분-2시간 |
| 10,000개 | 5MB | 5-8분 | 30분-1시간 | 1-4시간 |

## 주의사항

1. **썸네일 미복사**: 원본 파일만 복사되며, 썸네일은 나중에 재생성 필요
2. **중복 확인 없음**: 동일한 스크립트를 여러 번 실행하면 중복 복사됨
3. **권한 확인**: `SUPABASE_SERVICE_ROLE_KEY` 사용으로 모든 데이터 접근 가능
4. **디스크 용량**: 타겟 경로에 충분한 저장 공간 필요

## 에러 해결

### 환경 변수 오류
```
❌ SUPABASE_URL과 SUPABASE_SERVICE_ROLE_KEY 환경변수가 필요합니다.
```
→ `.env` 파일 확인 또는 환경 변수 설정

### 파일 접근 오류
```
❌ 파일 복사 실패: /path/to/source -> /path/to/target
```
→ 파일 권한 또는 디스크 용량 확인

### DB 연결 오류
```
💥 치명적 오류 발생: connect ECONNREFUSED
```
→ Supabase URL/키 확인 또는 네트워크 연결 확인

## 개발자 정보

이 스크립트는 Next.js 15 이미지 업로더의 폴더 시스템(`src/utils/folder-system.ts`)을 기반으로 작성되었습니다.