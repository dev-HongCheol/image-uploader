name: Build and Deploy with Multi-stage Docker

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["master"]
    types:
      - closed
  workflow_dispatch:

env:
  NODE_VERSION: "20.11"
  CONTAINER_NAME: "image-uploader"
  CONTAINER_PORT: "23333:3000"
  # BuildKit í™œì„±í™”
  DOCKER_BUILDKIT: 1
  BUILDX_PLATFORMS: "linux/arm64"

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  docker-build-and-deploy:
    name: Multi-stage Docker Build and Deploy
    runs-on: [self-hosted]
    environment: SERVER_HOST
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ë” ë¹ ë¥¸ ì²´í¬ì•„ì›ƒì„ ìœ„í•´ shallow clone ì‚¬ìš©
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # BuildKit ê¸°ëŠ¥ í™œì„±í™”
          driver-opts: |
            image=moby/buildkit:buildx-stable-1
          # ARM64 í”Œë«í¼ ì„¤ì •
          platforms: linux/arm64

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set lowercase repository name
        id: repo
        run: echo "repository=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ steps.repo.outputs.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          push: false
          platforms: linux/arm64
          tags: my-node-base
          cache-from: |
            type=gha,scope=buildkit-base
          cache-to: type=gha,mode=max,scope=buildkit-base

      - name: Build multi-stage Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.fast
          push: true
          platforms: linux/arm64
          tags: |
            ghcr.io/${{ steps.repo.outputs.repository }}:${{ github.ref_name }}
            ghcr.io/${{ steps.repo.outputs.repository }}:${{ github.ref_name }}-${{ github.sha }}
            ghcr.io/${{ steps.repo.outputs.repository }}:latest
          labels: ${{ steps.meta.outputs.labels }}
          # BuildKit ìºì‹± ìµœì í™”
          cache-from: |
            type=gha,scope=buildkit-${{ github.ref_name }}
            type=gha,scope=buildkit-main
          cache-to: type=gha,mode=max,scope=buildkit-${{ github.ref_name }}
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            NEXT_PUBLIC_SUPABASE_URL=${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=${{ vars.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ vars.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
          # ë¹Œë“œ ìµœì í™” ì˜µì…˜ (node_cache ì œê±°)

      - name: Deploy to Orange Pi Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USERNAME }}
          port: 30022
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: GITHUB_SHA,GITHUB_REF_NAME
          script: |
            set -e

            CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
            IMAGE="ghcr.io/${{ steps.repo.outputs.repository }}:${{ github.ref_name }}"
            BACKUP_IMAGE="ghcr.io/${{ steps.repo.outputs.repository }}:backup"

            echo "ğŸ·ï¸  Current deployment: $IMAGE"
            echo "ğŸ“Š Git SHA: $GITHUB_SHA"

            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë°±ì—…
            echo "ğŸ’¾ Creating backup of current container..."
            if docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
              docker commit $CONTAINER_NAME $BACKUP_IMAGE || true
              echo "âœ… Backup created: $BACKUP_IMAGE"
            fi

            # ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜ (ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼)
            health_check() {
              local container=$1
              local max_attempts=30
              local attempt=1
              
              echo "ğŸ¥ Health checking container: $container"
              while [ $attempt -le $max_attempts ]; do
                # ë‹¨ìˆœíˆ ë©”ì¸ í˜ì´ì§€ê°€ 200 ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸
                if curl -f -s http://localhost:23333 >/dev/null 2>&1; then
                  echo "âœ… Health check passed on attempt $attempt"
                  return 0
                fi
                echo "â³ Health check attempt $attempt/$max_attempts failed, waiting..."
                sleep 10
                attempt=$((attempt + 1))
              done
              
              echo "âŒ Health check failed after $max_attempts attempts"
              return 1
            }

            # ë¡¤ë°± í•¨ìˆ˜
            rollback() {
              echo "ğŸ”„ Rolling back to previous version..."
              docker stop $CONTAINER_NAME || true
              docker rm $CONTAINER_NAME || true
              
              if docker images -q $BACKUP_IMAGE | grep -q .; then
                docker run -d -p ${{ env.CONTAINER_PORT }} --name $CONTAINER_NAME \
                  --restart unless-stopped \
                  --log-driver json-file \
                  --log-opt max-size=10m \
                  --log-opt max-file=3 \
                  $BACKUP_IMAGE
                echo "âœ… Rollback completed"
              else
                echo "âŒ No backup image found for rollback"
                exit 1
              fi
            }

            echo "ğŸ”„ Stopping existing container..."
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            echo "ğŸ“¦ Pulling latest image..."
            if ! docker pull $IMAGE; then
              echo "âŒ Failed to pull image"
              rollback
              exit 1
            fi

            echo "ğŸš€ Starting new container..."
            if ! docker run -d -p ${{ env.CONTAINER_PORT }} --name $CONTAINER_NAME \
              --restart unless-stopped \
              --log-driver json-file \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              --memory=1g \
              --cpus=1.5 \
              $IMAGE; then
              echo "âŒ Failed to start container"
              rollback
              exit 1
            fi

            # í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
            if ! health_check $CONTAINER_NAME; then
              echo "âŒ Health check failed, rolling back..."
              rollback
              exit 1
            fi

            echo "ğŸ§¹ Cleaning up old images and containers..."
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ (ë°±ì—… ì´ë¯¸ì§€ ì œì™¸)
            docker image prune -f --filter "until=24h"

            # ì¤‘ì§€ëœ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker container prune -f

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³¼ë¥¨ ì •ë¦¬
            docker volume prune -f

            # ë¹Œë“œ ìºì‹œ ì •ë¦¬ (ìš©ëŸ‰ ì ˆì•½)
            docker builder prune -f --filter "until=48h"

            echo "ğŸ“Š Deployment Statistics:"
            echo "Container Status: $(docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | grep $CONTAINER_NAME)"
            echo "Image Size: $(docker images --format 'table {{.Repository}}\t{{.Tag}}\t{{.Size}}' | grep ${{ steps.repo.outputs.repository }})"
            echo "Disk Usage: $(df -h / | tail -1 | awk '{print $4" available of "$2}')"
            echo "Memory Usage: $(free -h | grep Mem | awk '{print $3"/"$2}')"

            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application is running at: http://$(hostname -I | awk '{print $1}'):23333"

      - name: Post-deployment cleanup and monitoring
        if: always()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USERNAME }}
          port: 30022
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
            echo "ğŸ“ˆ System Resources After Deployment:"
            echo "CPU Usage: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)%"
            echo "Memory Usage: $(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}')"
            echo "Disk Usage: $(df -h / | awk 'NR==2{printf "%s", $5}')"

            # Docker ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
            echo "ğŸ³ Docker Resources:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

            # ë¡œê·¸ í™•ì¸ (ë§ˆì§€ë§‰ 10ì¤„)
            echo "ğŸ“‹ Recent application logs:"
            docker logs --tail 10 ${{ env.CONTAINER_NAME }} || true

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-failure:
    name: Notify Deployment Failure
    runs-on: [self-hosted]
    needs: docker-build-and-deploy
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "âŒ Deployment failed for commit ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          # ì—¬ê¸°ì— Slack, Discord ë“± ì•Œë¦¼ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
